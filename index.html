<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日記本管理系統</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .mdc-card {
            padding: 20px;
            margin-bottom: 20px;
        }
        .image-card {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .note-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="mdc-layout-grid">
        <div class="mdc-card mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
            <h1 class="mdc-typography--headline4">日記本管理系統</h1>
            
            <!-- 圖片管理區塊 -->
            <div class="mdc-card mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                <h2 class="mdc-typography--headline5">圖片管理</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="getAllImages" class="mdc-button mdc-button--raised mdc-button--primary">
                        <span class="mdc-button__label">取得所有圖片</span>
                    </button>
                    <button id="uploadImageBtn" class="mdc-button mdc-button--raised">
                        <i class="material-icons mdc-button__icon">add</i>
                        <span class="mdc-button__label">上傳圖片</span>
                    </button>
                </div>
                <div id="imagesContainer"></div>
            </div>
            
            <!-- 文章管理區塊 -->
            <div class="mdc-card mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                <h2 class="mdc-typography--headline5">文章管理</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="getAllNotes" class="mdc-button mdc-button--raised mdc-button--primary">
                        <span class="mdc-button__label">取得所有文章</span>
                    </button>
                    <button id="createNoteBtn" class="mdc-button mdc-button--raised">
                        <i class="material-icons mdc-button__icon">add</i>
                        <span class="mdc-button__label">新增文章</span>
                    </button>
                </div>
                <div id="notesContainer"></div>
            </div>
            
            <!-- 圖片上傳表單 -->
            <div id="imageUploadForm" class="mdc-card mdc-layout-grid__cell mdc-layout-grid__cell--span-12" style="display: none;">
                <h2 class="mdc-typography--headline5">上傳圖片</h2>
                <form id="uploadForm">
                    <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%; margin-bottom: 15px;">
                        <input type="file" id="imageFile" class="mdc-text-field__input" accept="image/*" required>
                        <div class="mdc-notched-outline">
                            <div class="mdc-notched-outline__leading"></div>
                            <div class="mdc-notched-outline__notch">
                                <label class="mdc-floating-label">選擇圖片</label>
                            </div>
                            <div class="mdc-notched-outline__trailing"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="mdc-button mdc-button--raised mdc-button--primary">
                            <span class="mdc-button__label">上傳</span>
                        </button>
                        <button type="button" id="cancelUploadBtn" class="mdc-button mdc-button--outlined">
                            <span class="mdc-button__label">取消</span>
                        </button>
                    </div>
                </form>
                <div id="imageResult" class="mt-3"></div>
            </div>
            
            <!-- Markdown編輯表單 -->
            <div id="markdownEditor" class="mdc-card mdc-layout-grid__cell mdc-layout-grid__cell--span-12" style="display: none;">
                <h2 class="mdc-typography--headline5">編輯文章</h2>
                <textarea id="markdownContent" placeholder="輸入Markdown內容..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button id="saveMarkdown" class="mdc-button mdc-button--raised mdc-button--primary">
                        <span class="mdc-button__label">儲存</span>
                    </button>
                    <button id="cancelEditBtn" class="mdc-button mdc-button--outlined">
                        <span class="mdc-button__label">取消</span>
                    </button>
                </div>
                <div id="markdownResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        // 添加變數跟蹤當前編輯的文章ID
        let currentEditingNoteId = null;
        
        // API 基礎路徑
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        // 初始化Material Components
        document.addEventListener('DOMContentLoaded', () => {
            const buttons = document.querySelectorAll('.mdc-button');
            buttons.forEach(button => {
                mdc.ripple.MDCRipple.attachTo(button);
            });
            
            const textFields = document.querySelectorAll('.mdc-text-field');
            textFields.forEach(textField => {
                mdc.textField.MDCTextField.attachTo(textField);
            });
        });
        
        // 顯示/隱藏表單
        document.getElementById('uploadImageBtn').addEventListener('click', () => {
            document.getElementById('imageUploadForm').style.display = 'block';
        });
        
        document.getElementById('cancelUploadBtn').addEventListener('click', () => {
            document.getElementById('imageUploadForm').style.display = 'none';
        });
        
        document.getElementById('createNoteBtn').addEventListener('click', () => {
            document.getElementById('markdownEditor').style.display = 'block';
            document.getElementById('markdownContent').value = '';
            // 重置編輯ID，表示這是一篇新文章
            currentEditingNoteId = null;
        });
        
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('markdownEditor').style.display = 'none';
            currentEditingNoteId = null; // 取消時也重置編輯ID
        });
        
        // 圖片上傳處理
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('imageFile');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/images/upload/`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                document.getElementById('imageResult').innerHTML = 
                    `<div class="mdc-card">
                        <p>圖片上傳成功！</p>
                        <p>URL: <a href="${data.url}" target="_blank">${data.url}</a></p>
                        <img src="${data.url}" style="max-width: 300px; margin-top: 10px;">
                    </div>`;
                document.getElementById('imageUploadForm').style.display = 'none';
            } catch (error) {
                document.getElementById('imageResult').innerHTML = 
                    `<div class="mdc-card" style="color: red;">
                        <p>上傳失敗: ${error.message}</p>
                    </div>`;
            }
        });

        // Markdown保存處理
        document.getElementById('saveMarkdown').addEventListener('click', async () => {
            const content = document.getElementById('markdownContent').value;
            if (!content) {
                alert('請輸入Markdown內容');
                return;
            }

            try {
                // 判斷是新增還是更新
                let url, method;
                if (currentEditingNoteId) {
                    // 更新現有文章
                    url = `${API_BASE_URL}/notes/${currentEditingNoteId}`;
                    method = 'PUT';
                } else {
                    // 新增文章
                    url = `${API_BASE_URL}/notes/create/`;
                    method = 'POST';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: btoa(unescape(encodeURIComponent(content)))
                    })
                });
                
                const data = await response.json();
                
                let message;
                if (currentEditingNoteId) {
                    message = `<p>${data.message}</p>`;
                } else {
                    message = `
                        <p>${data.message}</p>
                        <p>內容長度: ${data.content_length} 字元</p>
                    `;
                }
                
                document.getElementById('markdownResult').innerHTML = 
                    `<div class="mdc-card">${message}</div>`;
                    
                document.getElementById('markdownEditor').style.display = 'none';
                currentEditingNoteId = null; // 重置編輯ID
                
                // 重新載入文章列表
                document.getElementById('getAllNotes').click();
            } catch (error) {
                document.getElementById('markdownResult').innerHTML = 
                    `<div class="mdc-card" style="color: red;">
                        <p>儲存失敗: ${error.message}</p>
                    </div>`;
            }
        });
        
        // 获取所有图片
        document.getElementById('getAllImages').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/images/all/`);
                const data = await response.json();
                console.log("API返回圖片數據:", data); // 調試用
                
                let imagesHTML = '<h3>所有圖片</h3><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
                
                // 添加檢查确保data.images是數組且非空
                if (data.images && Array.isArray(data.images) && data.images.length > 0) {
                    data.images.forEach(img => {
                        // 從數組中獲取文件名 (img[1])
                        const filename = img && img[1] ? img[1] : '';
                        
                        // 使用文件名直接構建新的URL路徑
                        const imgUrl = `${API_BASE_URL}/images/get/${filename}`;
                        console.log("構建圖片URL:", imgUrl); // 調試用
                        
                        imagesHTML += `
                        <div class="mdc-card image-card">
                            <img src="${imgUrl}" style="width: 100%; height: 200px; object-fit: cover;">
                            <div class="mdc-card__actions" style="justify-content: flex-end; padding: 8px;">
                                <button class="mdc-button mdc-button--raised mdc-button--error" onclick="deleteImage('${filename}')">
                                    <i class="material-icons mdc-button__icon">delete</i>
                                    <span class="mdc-button__label">刪除</span>
                                </button>
                            </div>
                            <div class="mdc-card__content" style="padding: 8px;">
                                <p>${filename}</p>
                            </div>
                        </div>`;
                    });
                } else {
                    imagesHTML += '<p>沒有找到圖片</p>';
                }
                
                imagesHTML += '</div>';
                
                document.getElementById('imagesContainer').innerHTML = imagesHTML;
            } catch (error) {
                document.getElementById('imagesContainer').innerHTML = 
                    `<div class="mdc-card" style="color: red;">
                        <p>取得圖片失敗: ${error.message}</p>
                    </div>`;
            }
        });
        
        // 获取所有文章
        document.getElementById('getAllNotes').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/notes/all/`);
                const data = await response.json();
                
                let notesHTML = '<h3>所有文章</h3><div style="display: flex; flex-direction: column; gap: 15px;">';
                
                // 新版API返回的是對象數組，而不是二維數組
                data.notes.forEach(note => {
                    // 處理標籤顯示（如果有）
                    let tagsHtml = '';
                    if (note.tags && note.tags.length > 0) {
                        tagsHtml = '<div class="tags" style="margin-top: 10px;">';
                        note.tags.forEach(tag => {
                            tagsHtml += `<span style="background: #eee; padding: 2px 8px; border-radius: 12px; margin-right: 5px; font-size: 14px;">${tag}</span>`;
                        });
                        tagsHtml += '</div>';
                    }
                    
                    notesHTML += `
                    <div class="mdc-card note-card">
                        <div class="mdc-card__content">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>ID:</strong> ${note.id}</span>
                                <span><strong>建立時間:</strong> ${note.created_at}</span>
                            </div>
                            <div style="border-top: 1px solid #eee; padding-top: 10px;">
                                ${marked.parse(note.content)}
                            </div>
                            ${tagsHtml}
                        </div>
                        <div class="mdc-card__actions" style="justify-content: flex-end;">
                            <button class="mdc-button mdc-button--outlined" onclick="editNote('${note.id}')">
                                <i class="material-icons mdc-button__icon">edit</i>
                                <span class="mdc-button__label">編輯</span>
                            </button>
                            <button class="mdc-button mdc-button--outlined mdc-button--error" onclick="deleteNote('${note.id}')">
                                <i class="material-icons mdc-button__icon">delete</i>
                                <span class="mdc-button__label">刪除</span>
                            </button>
                        </div>
                    </div>`;
                });
                notesHTML += '</div>';
                
                document.getElementById('notesContainer').innerHTML = notesHTML;
            } catch (error) {
                document.getElementById('notesContainer').innerHTML = 
                    `<div class="mdc-card" style="color: red;">
                        <p>取得文章失敗: ${error.message}</p>
                    </div>`;
            }
        });
        
        // 刪除圖片
        async function deleteImage(filename) {
            if (!confirm('確定要刪除此圖片嗎？')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/images/delete/${filename}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                alert(data.message);
                document.getElementById('getAllImages').click();
            } catch (error) {
                alert(`刪除失敗: ${error.message}`);
            }
        }
        
        // 刪除文章
        async function deleteNote(id) {
            if (!confirm('確定要刪除此文章嗎？')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/notes/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                alert(data.message);
                document.getElementById('getAllNotes').click();
            } catch (error) {
                alert(`刪除失敗: ${error.message}`);
            }
        }
        
        // 編輯文章
        async function editNote(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/notes/${id}`);
                const data = await response.json();
                
                // 檢查返回的資料格式 (適配新的API格式)
                if (data.note && data.note.content) {
                    const content = data.note.content;
                    
                    // 記錄當前編輯的文章ID
                    currentEditingNoteId = id;
                    
                    // 顯示編輯器並設定內容
                    document.getElementById('markdownContent').value = content;
                    document.getElementById('markdownEditor').style.display = 'block';
                } else {
                    alert('文章格式錯誤');
                }
            } catch (error) {
                alert(`取得文章失敗: ${error.message}`);
            }
        }
    </script>
</body>
</html>